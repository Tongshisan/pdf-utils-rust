<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PDF & å›¾ç‰‡å·¥å…· - WASM ç¤ºä¾‹</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
          "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      h1 {
        color: white;
        text-align: center;
        margin-bottom: 30px;
        font-size: 2.5em;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
      }

      .tools-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .tool-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        transition: transform 0.3s ease;
      }

      .tool-card:hover {
        transform: translateY(-5px);
      }

      .tool-card h2 {
        color: #667eea;
        margin-bottom: 15px;
        font-size: 1.5em;
      }

      .tool-card p {
        color: #666;
        margin-bottom: 20px;
        line-height: 1.6;
      }

      .file-input {
        display: block;
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 2px dashed #667eea;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .file-input:hover {
        background: #f5f5f5;
        border-color: #764ba2;
      }

      button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        width: 100%;
        transition: all 0.3s;
        margin-top: 10px;
      }

      button:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      .result {
        margin-top: 15px;
        padding: 15px;
        background: #f0f7ff;
        border-radius: 8px;
        border-left: 4px solid #667eea;
        display: none;
      }

      .result.show {
        display: block;
      }

      .result.error {
        background: #fff0f0;
        border-left-color: #f44336;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .input-group {
        margin-bottom: 15px;
      }

      .input-group label {
        display: block;
        margin-bottom: 5px;
        color: #333;
        font-weight: 500;
      }

      .input-group input[type="number"],
      .input-group input[type="text"] {
        width: 100%;
        padding: 10px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
      }

      .input-group input[type="number"]:focus,
      .input-group input[type="text"]:focus {
        outline: none;
        border-color: #667eea;
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
      }

      .checkbox-group input[type="checkbox"] {
        margin-right: 8px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ“„ PDF & å›¾ç‰‡å¤„ç†å·¥å…·</h1>

      <div class="tools-grid">
        <!-- PDF åˆå¹¶ -->
        <div class="tool-card">
          <h2>ğŸ“‘ PDF åˆå¹¶</h2>
          <p>é€‰æ‹©å¤šä¸ª PDF æ–‡ä»¶ï¼Œåˆå¹¶ä¸ºä¸€ä¸ªæ–‡ä»¶</p>
          <input
            type="file"
            id="mergePdfFiles"
            class="file-input"
            accept=".pdf"
            multiple
          />
          <button onclick="mergePdfs()">åˆå¹¶ PDF</button>
          <div id="mergeResult" class="result"></div>
        </div>

        <!-- PDF åˆ†å‰² -->
        <div class="tool-card">
          <h2>âœ‚ï¸ PDF åˆ†å‰²</h2>
          <p>å°† PDF æ–‡ä»¶åˆ†å‰²æˆå•ç‹¬çš„é¡µé¢</p>
          <input
            type="file"
            id="splitPdfFile"
            class="file-input"
            accept=".pdf"
          />
          <button onclick="splitPdf()">åˆ†å‰² PDF</button>
          <div id="splitResult" class="result"></div>
        </div>

        <!-- å›¾ç‰‡è½¬ PDF -->
        <div class="tool-card">
          <h2>ğŸ–¼ï¸ å›¾ç‰‡è½¬ PDF</h2>
          <p>å°†å¤šå¼ å›¾ç‰‡åˆå¹¶ä¸ºä¸€ä¸ª PDF æ–‡ä»¶</p>
          <input
            type="file"
            id="imagesToPdfFiles"
            class="file-input"
            accept="image/*"
            multiple
          />
          <button onclick="imagesToPdf()">è½¬æ¢ä¸º PDF</button>
          <div id="img2pdfResult" class="result"></div>
        </div>

        <!-- å›¾ç‰‡æ ¼å¼è½¬æ¢ -->
        <div class="tool-card">
          <h2>ğŸ”„ å›¾ç‰‡æ ¼å¼è½¬æ¢</h2>
          <p>è½¬æ¢å›¾ç‰‡æ ¼å¼ï¼ˆJPEG, PNG, BMP ç­‰ï¼‰</p>
          <input
            type="file"
            id="convertImageFile"
            class="file-input"
            accept="image/*"
          />
          <div class="input-group">
            <label>ç›®æ ‡æ ¼å¼:</label>
            <select
              id="targetFormat"
              style="
                width: 100%;
                padding: 10px;
                border-radius: 8px;
                border: 2px solid #e0e0e0;
              "
            >
              <option value="png">PNG</option>
              <option value="jpeg">JPEG</option>
              <option value="bmp">BMP</option>
              <option value="gif">GIF</option>
            </select>
          </div>
          <div class="input-group">
            <label>è´¨é‡ (ä»… JPEG, 0-100):</label>
            <input
              type="number"
              id="convertQuality"
              value="85"
              min="0"
              max="100"
            />
          </div>
          <button onclick="convertImage()">è½¬æ¢æ ¼å¼</button>
          <div id="convertResult" class="result"></div>
        </div>

        <!-- å›¾ç‰‡è°ƒæ•´å¤§å° -->
        <div class="tool-card">
          <h2>ğŸ“ è°ƒæ•´å›¾ç‰‡å¤§å°</h2>
          <p>æ”¹å˜å›¾ç‰‡çš„å°ºå¯¸</p>
          <input
            type="file"
            id="resizeImageFile"
            class="file-input"
            accept="image/*"
          />
          <div class="input-group">
            <label>å®½åº¦ (px):</label>
            <input type="number" id="resizeWidth" value="800" min="1" />
          </div>
          <div class="input-group">
            <label>é«˜åº¦ (px):</label>
            <input type="number" id="resizeHeight" value="600" min="1" />
          </div>
          <div class="checkbox-group">
            <input type="checkbox" id="maintainRatio" checked />
            <label>ä¿æŒå®½é«˜æ¯”</label>
          </div>
          <button onclick="resizeImage()">è°ƒæ•´å¤§å°</button>
          <div id="resizeResult" class="result"></div>
        </div>

        <!-- å›¾ç‰‡å‹ç¼© -->
        <div class="tool-card">
          <h2>ğŸ—œï¸ å›¾ç‰‡å‹ç¼©</h2>
          <p>å‹ç¼©å›¾ç‰‡ä»¥å‡å°æ–‡ä»¶å¤§å°</p>
          <input
            type="file"
            id="compressImageFile"
            class="file-input"
            accept="image/*"
          />
          <div class="input-group">
            <label>å‹ç¼©è´¨é‡ (0-100, è¶Šä½æ–‡ä»¶è¶Šå°):</label>
            <input
              type="number"
              id="compressQuality"
              value="75"
              min="0"
              max="100"
            />
          </div>
          <button onclick="compressImage()">å‹ç¼©å›¾ç‰‡</button>
          <div id="compressResult" class="result"></div>
        </div>

        <!-- å›¾ç‰‡æ—‹è½¬ -->
        <div class="tool-card">
          <h2>ğŸ”„ æ—‹è½¬å›¾ç‰‡</h2>
          <p>æ—‹è½¬å›¾ç‰‡ 90Â°ã€180Â° æˆ– 270Â°</p>
          <input
            type="file"
            id="rotateImageFile"
            class="file-input"
            accept="image/*"
          />
          <div class="input-group">
            <label>æ—‹è½¬è§’åº¦:</label>
            <select
              id="rotateDegrees"
              style="
                width: 100%;
                padding: 10px;
                border-radius: 8px;
                border: 2px solid #e0e0e0;
              "
            >
              <option value="90">90Â°</option>
              <option value="180">180Â°</option>
              <option value="270">270Â°</option>
            </select>
          </div>
          <button onclick="rotateImage()">æ—‹è½¬å›¾ç‰‡</button>
          <div id="rotateResult" class="result"></div>
        </div>

        <!-- è·å–å›¾ç‰‡ä¿¡æ¯ -->
        <div class="tool-card">
          <h2>â„¹ï¸ å›¾ç‰‡ä¿¡æ¯</h2>
          <p>æŸ¥çœ‹å›¾ç‰‡çš„è¯¦ç»†ä¿¡æ¯</p>
          <input
            type="file"
            id="infoImageFile"
            class="file-input"
            accept="image/*"
          />
          <button onclick="getImageInfo()">è·å–ä¿¡æ¯</button>
          <div id="infoResult" class="result"></div>
        </div>
      </div>
    </div>

    <script type="module">
      import init, * as wasm from "./pkg/pdf_utils_rust.js";

      let wasmModule;

      async function initWasm() {
        try {
          console.log("ğŸ”„ åˆå§‹åŒ– WASM æ¨¡å—");
          wasmModule = await init();
          console.log("âœ… WASM æ¨¡å—åŠ è½½æˆåŠŸ");
          window.wasm = wasm;
        } catch (e) {
          console.error("âŒ WASM æ¨¡å—åŠ è½½å¤±è´¥:", e);
          alert("WASM æ¨¡å—åŠ è½½å¤±è´¥ï¼Œè¯·ç¡®ä¿å·²æ„å»º WASM åŒ…");
        }
      }

      initWasm();

      function downloadFile(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      window.mergePdfs = async function () {
        const files = document.getElementById("mergePdfFiles").files;
        const result = document.getElementById("mergeResult");

        if (files.length < 2) {
          result.className = "result error show";
          result.textContent = "âŒ è¯·é€‰æ‹©è‡³å°‘ 2 ä¸ª PDF æ–‡ä»¶";
          return;
        }

        try {
          const pdfArrays = [];
          for (let file of files) {
            const buffer = await file.arrayBuffer();
            pdfArrays.push(new Uint8Array(buffer));
          }

          const merged = wasm.merge_pdfs(pdfArrays);
          const blob = new Blob([merged], { type: "application/pdf" });
          downloadFile(blob, "merged.pdf");

          result.className = "result show";
          result.textContent = "âœ… PDF åˆå¹¶æˆåŠŸï¼å·²ä¸‹è½½æ–‡ä»¶ã€‚";
        } catch (e) {
          result.className = "result error show";
          result.textContent = "âŒ é”™è¯¯: " + e;
        }
      };

      window.splitPdf = async function () {
        const file = document.getElementById("splitPdfFile").files[0];
        const result = document.getElementById("splitResult");

        if (!file) {
          result.className = "result error show";
          result.textContent = "âŒ è¯·é€‰æ‹©ä¸€ä¸ª PDF æ–‡ä»¶";
          return;
        }

        try {
          const buffer = await file.arrayBuffer();
          const pages = wasm.split_pdf(new Uint8Array(buffer));

          for (let i = 0; i < pages.length; i++) {
            const blob = new Blob([pages[i]], { type: "application/pdf" });
            downloadFile(blob, `page_${i + 1}.pdf`);
          }

          result.className = "result show";
          result.textContent = `âœ… PDF å·²åˆ†å‰²ä¸º ${pages.length} ä¸ªæ–‡ä»¶å¹¶ä¸‹è½½ã€‚`;
        } catch (e) {
          result.className = "result error show";
          result.textContent = "âŒ é”™è¯¯: " + e;
        }
      };

      window.imagesToPdf = async function () {
        const files = document.getElementById("imagesToPdfFiles").files;
        const result = document.getElementById("img2pdfResult");

        if (files.length < 1) {
          result.className = "result error show";
          result.textContent = "âŒ è¯·é€‰æ‹©è‡³å°‘ 1 å¼ å›¾ç‰‡";
          return;
        }

        try {
          const imageArrays = [];
          for (let file of files) {
            const buffer = await file.arrayBuffer();
            imageArrays.push(new Uint8Array(buffer));
          }

          const pdf = wasm.images_to_pdf(imageArrays);
          const blob = new Blob([pdf], { type: "application/pdf" });
          downloadFile(blob, "images.pdf");

          result.className = "result show";
          result.textContent = "âœ… å›¾ç‰‡å·²è½¬æ¢ä¸º PDF å¹¶ä¸‹è½½ï¼";
        } catch (e) {
          result.className = "result error show";
          result.textContent = "âŒ é”™è¯¯: " + e;
        }
      };

      window.convertImage = async function () {
        const file = document.getElementById("convertImageFile").files[0];
        const format = document.getElementById("targetFormat").value;
        const quality = parseInt(
          document.getElementById("convertQuality").value
        );
        const result = document.getElementById("convertResult");

        if (!file) {
          result.className = "result error show";
          result.textContent = "âŒ è¯·é€‰æ‹©ä¸€å¼ å›¾ç‰‡";
          return;
        }

        try {
          const buffer = await file.arrayBuffer();
          const converted = wasm.convert_image_format(
            new Uint8Array(buffer),
            format,
            quality
          );
          const blob = new Blob([converted], { type: `image/${format}` });
          downloadFile(blob, `converted.${format}`);

          result.className = "result show";
          result.textContent = "âœ… å›¾ç‰‡æ ¼å¼è½¬æ¢æˆåŠŸå¹¶ä¸‹è½½ï¼";
        } catch (e) {
          result.className = "result error show";
          result.textContent = "âŒ é”™è¯¯: " + e;
        }
      };

      window.resizeImage = async function () {
        const file = document.getElementById("resizeImageFile").files[0];
        const width = parseInt(document.getElementById("resizeWidth").value);
        const height = parseInt(document.getElementById("resizeHeight").value);
        const maintainRatio = document.getElementById("maintainRatio").checked;
        const result = document.getElementById("resizeResult");

        if (!file) {
          result.className = "result error show";
          result.textContent = "âŒ è¯·é€‰æ‹©ä¸€å¼ å›¾ç‰‡";
          return;
        }

        try {
          const buffer = await file.arrayBuffer();
          const resized = wasm.resize_image(
            new Uint8Array(buffer),
            width,
            height,
            maintainRatio
          );
          const blob = new Blob([resized], { type: file.type });
          downloadFile(blob, `resized_${file.name}`);

          result.className = "result show";
          result.textContent = "âœ… å›¾ç‰‡å¤§å°è°ƒæ•´æˆåŠŸå¹¶ä¸‹è½½ï¼";
        } catch (e) {
          result.className = "result error show";
          result.textContent = "âŒ é”™è¯¯: " + e;
        }
      };

      window.compressImage = async function () {
        const file = document.getElementById("compressImageFile").files[0];
        const quality = parseInt(
          document.getElementById("compressQuality").value
        );
        const result = document.getElementById("compressResult");

        if (!file) {
          result.className = "result error show";
          result.textContent = "âŒ è¯·é€‰æ‹©ä¸€å¼ å›¾ç‰‡";
          return;
        }

        try {
          const buffer = await file.arrayBuffer();
          const originalSize = buffer.byteLength;
          const compressed = wasm.compress_image(
            new Uint8Array(buffer),
            quality
          );
          const newSize = compressed.length;
          const reduction = ((1 - newSize / originalSize) * 100).toFixed(1);

          const blob = new Blob([compressed], { type: "image/jpeg" });
          downloadFile(
            blob,
            `compressed_${file.name.replace(/\.[^.]+$/, ".jpg")}`
          );

          result.className = "result show";
          result.textContent = `âœ… å›¾ç‰‡å‹ç¼©æˆåŠŸï¼åŸå§‹: ${(
            originalSize / 1024
          ).toFixed(1)}KB â†’ å‹ç¼©å: ${(newSize / 1024).toFixed(
            1
          )}KB (å‡å°‘ ${reduction}%)`;
        } catch (e) {
          result.className = "result error show";
          result.textContent = "âŒ é”™è¯¯: " + e;
        }
      };

      window.rotateImage = async function () {
        const file = document.getElementById("rotateImageFile").files[0];
        const degrees = parseInt(
          document.getElementById("rotateDegrees").value
        );
        const result = document.getElementById("rotateResult");

        if (!file) {
          result.className = "result error show";
          result.textContent = "âŒ è¯·é€‰æ‹©ä¸€å¼ å›¾ç‰‡";
          return;
        }

        try {
          const buffer = await file.arrayBuffer();
          const rotated = wasm.rotate_image(new Uint8Array(buffer), degrees);
          const blob = new Blob([rotated], { type: file.type });
          downloadFile(blob, `rotated_${degrees}_${file.name}`);

          result.className = "result show";
          result.textContent = `âœ… å›¾ç‰‡å·²æ—‹è½¬ ${degrees}Â° å¹¶ä¸‹è½½ï¼`;
        } catch (e) {
          result.className = "result error show";
          result.textContent = "âŒ é”™è¯¯: " + e;
        }
      };

      window.getImageInfo = async function () {
        const file = document.getElementById("infoImageFile").files[0];
        const result = document.getElementById("infoResult");

        if (!file) {
          result.className = "result error show";
          result.textContent = "âŒ è¯·é€‰æ‹©ä¸€å¼ å›¾ç‰‡";
          return;
        }

        try {
          const buffer = await file.arrayBuffer();
          const info = JSON.parse(wasm.get_image_info(new Uint8Array(buffer)));

          result.className = "result show";
          result.innerHTML = `
                    <strong>å›¾ç‰‡ä¿¡æ¯ï¼š</strong><br>
                    ğŸ“ å°ºå¯¸: ${info.width} Ã— ${info.height} px<br>
                    ğŸ¨ æ ¼å¼: ${info.format}<br>
                    ğŸ–¼ï¸ é¢œè‰²ç±»å‹: ${info.color_type}<br>
                    ğŸ“¦ æ–‡ä»¶å¤§å°: ${(file.size / 1024).toFixed(2)} KB
                `;
        } catch (e) {
          result.className = "result error show";
          result.textContent = "âŒ é”™è¯¯: " + e;
        }
      };
    </script>
  </body>
</html>
