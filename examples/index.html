<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PDF & 图片工具 - WASM 示例</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
          "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      h1 {
        color: white;
        text-align: center;
        margin-bottom: 30px;
        font-size: 2.5em;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
      }

      .tools-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .tool-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        transition: transform 0.3s ease;
      }

      .tool-card:hover {
        transform: translateY(-5px);
      }

      .tool-card h2 {
        color: #667eea;
        margin-bottom: 15px;
        font-size: 1.5em;
      }

      .tool-card p {
        color: #666;
        margin-bottom: 20px;
        line-height: 1.6;
      }

      .file-input {
        display: block;
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 2px dashed #667eea;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .file-input:hover {
        background: #f5f5f5;
        border-color: #764ba2;
      }

      button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        width: 100%;
        transition: all 0.3s;
        margin-top: 10px;
      }

      button:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      .result {
        margin-top: 15px;
        padding: 15px;
        background: #f0f7ff;
        border-radius: 8px;
        border-left: 4px solid #667eea;
        display: none;
      }

      .result.show {
        display: block;
      }

      .result.error {
        background: #fff0f0;
        border-left-color: #f44336;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .input-group {
        margin-bottom: 15px;
      }

      .input-group label {
        display: block;
        margin-bottom: 5px;
        color: #333;
        font-weight: 500;
      }

      .input-group input[type="number"],
      .input-group input[type="text"] {
        width: 100%;
        padding: 10px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
      }

      .input-group input[type="number"]:focus,
      .input-group input[type="text"]:focus {
        outline: none;
        border-color: #667eea;
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
      }

      .checkbox-group input[type="checkbox"] {
        margin-right: 8px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>📄 PDF & 图片处理工具</h1>

      <div class="tools-grid">
        <!-- PDF 合并 -->
        <div class="tool-card">
          <h2>📑 PDF 合并</h2>
          <p>选择多个 PDF 文件，合并为一个文件</p>
          <input
            type="file"
            id="mergePdfFiles"
            class="file-input"
            accept=".pdf"
            multiple
          />
          <button onclick="mergePdfs()">合并 PDF</button>
          <div id="mergeResult" class="result"></div>
        </div>

        <!-- PDF 分割 -->
        <div class="tool-card">
          <h2>✂️ PDF 分割</h2>
          <p>将 PDF 文件分割成单独的页面</p>
          <input
            type="file"
            id="splitPdfFile"
            class="file-input"
            accept=".pdf"
          />
          <button onclick="splitPdf()">分割 PDF</button>
          <div id="splitResult" class="result"></div>
        </div>

        <!-- 图片转 PDF -->
        <div class="tool-card">
          <h2>🖼️ 图片转 PDF</h2>
          <p>将多张图片合并为一个 PDF 文件</p>
          <input
            type="file"
            id="imagesToPdfFiles"
            class="file-input"
            accept="image/*"
            multiple
          />
          <button onclick="imagesToPdf()">转换为 PDF</button>
          <div id="img2pdfResult" class="result"></div>
        </div>

        <!-- 图片格式转换 -->
        <div class="tool-card">
          <h2>🔄 图片格式转换</h2>
          <p>转换图片格式（JPEG, PNG, BMP 等）</p>
          <input
            type="file"
            id="convertImageFile"
            class="file-input"
            accept="image/*"
          />
          <div class="input-group">
            <label>目标格式:</label>
            <select
              id="targetFormat"
              style="
                width: 100%;
                padding: 10px;
                border-radius: 8px;
                border: 2px solid #e0e0e0;
              "
            >
              <option value="png">PNG</option>
              <option value="jpeg">JPEG</option>
              <option value="bmp">BMP</option>
              <option value="gif">GIF</option>
            </select>
          </div>
          <div class="input-group">
            <label>质量 (仅 JPEG, 0-100):</label>
            <input
              type="number"
              id="convertQuality"
              value="85"
              min="0"
              max="100"
            />
          </div>
          <button onclick="convertImage()">转换格式</button>
          <div id="convertResult" class="result"></div>
        </div>

        <!-- 图片调整大小 -->
        <div class="tool-card">
          <h2>📐 调整图片大小</h2>
          <p>改变图片的尺寸</p>
          <input
            type="file"
            id="resizeImageFile"
            class="file-input"
            accept="image/*"
          />
          <div class="input-group">
            <label>宽度 (px):</label>
            <input type="number" id="resizeWidth" value="800" min="1" />
          </div>
          <div class="input-group">
            <label>高度 (px):</label>
            <input type="number" id="resizeHeight" value="600" min="1" />
          </div>
          <div class="checkbox-group">
            <input type="checkbox" id="maintainRatio" checked />
            <label>保持宽高比</label>
          </div>
          <button onclick="resizeImage()">调整大小</button>
          <div id="resizeResult" class="result"></div>
        </div>

        <!-- 图片压缩 -->
        <div class="tool-card">
          <h2>🗜️ 图片压缩</h2>
          <p>压缩图片以减小文件大小</p>
          <input
            type="file"
            id="compressImageFile"
            class="file-input"
            accept="image/*"
          />
          <div class="input-group">
            <label>压缩质量 (0-100, 越低文件越小):</label>
            <input
              type="number"
              id="compressQuality"
              value="75"
              min="0"
              max="100"
            />
          </div>
          <button onclick="compressImage()">压缩图片</button>
          <div id="compressResult" class="result"></div>
        </div>

        <!-- 图片旋转 -->
        <div class="tool-card">
          <h2>🔄 旋转图片</h2>
          <p>旋转图片 90°、180° 或 270°</p>
          <input
            type="file"
            id="rotateImageFile"
            class="file-input"
            accept="image/*"
          />
          <div class="input-group">
            <label>旋转角度:</label>
            <select
              id="rotateDegrees"
              style="
                width: 100%;
                padding: 10px;
                border-radius: 8px;
                border: 2px solid #e0e0e0;
              "
            >
              <option value="90">90°</option>
              <option value="180">180°</option>
              <option value="270">270°</option>
            </select>
          </div>
          <button onclick="rotateImage()">旋转图片</button>
          <div id="rotateResult" class="result"></div>
        </div>

        <!-- 获取图片信息 -->
        <div class="tool-card">
          <h2>ℹ️ 图片信息</h2>
          <p>查看图片的详细信息</p>
          <input
            type="file"
            id="infoImageFile"
            class="file-input"
            accept="image/*"
          />
          <button onclick="getImageInfo()">获取信息</button>
          <div id="infoResult" class="result"></div>
        </div>
      </div>
    </div>

    <script type="module">
      import init, * as wasm from "./pkg/pdf_utils_rust.js";

      let wasmModule;

      async function initWasm() {
        try {
          console.log("🔄 初始化 WASM 模块");
          wasmModule = await init();
          console.log("✅ WASM 模块加载成功");
          window.wasm = wasm;
        } catch (e) {
          console.error("❌ WASM 模块加载失败:", e);
          alert("WASM 模块加载失败，请确保已构建 WASM 包");
        }
      }

      initWasm();

      function downloadFile(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      window.mergePdfs = async function () {
        const files = document.getElementById("mergePdfFiles").files;
        const result = document.getElementById("mergeResult");

        if (files.length < 2) {
          result.className = "result error show";
          result.textContent = "❌ 请选择至少 2 个 PDF 文件";
          return;
        }

        try {
          const pdfArrays = [];
          for (let file of files) {
            const buffer = await file.arrayBuffer();
            pdfArrays.push(new Uint8Array(buffer));
          }

          const merged = wasm.merge_pdfs(pdfArrays);
          const blob = new Blob([merged], { type: "application/pdf" });
          downloadFile(blob, "merged.pdf");

          result.className = "result show";
          result.textContent = "✅ PDF 合并成功！已下载文件。";
        } catch (e) {
          result.className = "result error show";
          result.textContent = "❌ 错误: " + e;
        }
      };

      window.splitPdf = async function () {
        const file = document.getElementById("splitPdfFile").files[0];
        const result = document.getElementById("splitResult");

        if (!file) {
          result.className = "result error show";
          result.textContent = "❌ 请选择一个 PDF 文件";
          return;
        }

        try {
          const buffer = await file.arrayBuffer();
          const pages = wasm.split_pdf(new Uint8Array(buffer));

          for (let i = 0; i < pages.length; i++) {
            const blob = new Blob([pages[i]], { type: "application/pdf" });
            downloadFile(blob, `page_${i + 1}.pdf`);
          }

          result.className = "result show";
          result.textContent = `✅ PDF 已分割为 ${pages.length} 个文件并下载。`;
        } catch (e) {
          result.className = "result error show";
          result.textContent = "❌ 错误: " + e;
        }
      };

      window.imagesToPdf = async function () {
        const files = document.getElementById("imagesToPdfFiles").files;
        const result = document.getElementById("img2pdfResult");

        if (files.length < 1) {
          result.className = "result error show";
          result.textContent = "❌ 请选择至少 1 张图片";
          return;
        }

        try {
          const imageArrays = [];
          for (let file of files) {
            const buffer = await file.arrayBuffer();
            imageArrays.push(new Uint8Array(buffer));
          }

          const pdf = wasm.images_to_pdf(imageArrays);
          const blob = new Blob([pdf], { type: "application/pdf" });
          downloadFile(blob, "images.pdf");

          result.className = "result show";
          result.textContent = "✅ 图片已转换为 PDF 并下载！";
        } catch (e) {
          result.className = "result error show";
          result.textContent = "❌ 错误: " + e;
        }
      };

      window.convertImage = async function () {
        const file = document.getElementById("convertImageFile").files[0];
        const format = document.getElementById("targetFormat").value;
        const quality = parseInt(
          document.getElementById("convertQuality").value
        );
        const result = document.getElementById("convertResult");

        if (!file) {
          result.className = "result error show";
          result.textContent = "❌ 请选择一张图片";
          return;
        }

        try {
          const buffer = await file.arrayBuffer();
          const converted = wasm.convert_image_format(
            new Uint8Array(buffer),
            format,
            quality
          );
          const blob = new Blob([converted], { type: `image/${format}` });
          downloadFile(blob, `converted.${format}`);

          result.className = "result show";
          result.textContent = "✅ 图片格式转换成功并下载！";
        } catch (e) {
          result.className = "result error show";
          result.textContent = "❌ 错误: " + e;
        }
      };

      window.resizeImage = async function () {
        const file = document.getElementById("resizeImageFile").files[0];
        const width = parseInt(document.getElementById("resizeWidth").value);
        const height = parseInt(document.getElementById("resizeHeight").value);
        const maintainRatio = document.getElementById("maintainRatio").checked;
        const result = document.getElementById("resizeResult");

        if (!file) {
          result.className = "result error show";
          result.textContent = "❌ 请选择一张图片";
          return;
        }

        try {
          const buffer = await file.arrayBuffer();
          const resized = wasm.resize_image(
            new Uint8Array(buffer),
            width,
            height,
            maintainRatio
          );
          const blob = new Blob([resized], { type: file.type });
          downloadFile(blob, `resized_${file.name}`);

          result.className = "result show";
          result.textContent = "✅ 图片大小调整成功并下载！";
        } catch (e) {
          result.className = "result error show";
          result.textContent = "❌ 错误: " + e;
        }
      };

      window.compressImage = async function () {
        const file = document.getElementById("compressImageFile").files[0];
        const quality = parseInt(
          document.getElementById("compressQuality").value
        );
        const result = document.getElementById("compressResult");

        if (!file) {
          result.className = "result error show";
          result.textContent = "❌ 请选择一张图片";
          return;
        }

        try {
          const buffer = await file.arrayBuffer();
          const originalSize = buffer.byteLength;
          const compressed = wasm.compress_image(
            new Uint8Array(buffer),
            quality
          );
          const newSize = compressed.length;
          const reduction = ((1 - newSize / originalSize) * 100).toFixed(1);

          const blob = new Blob([compressed], { type: "image/jpeg" });
          downloadFile(
            blob,
            `compressed_${file.name.replace(/\.[^.]+$/, ".jpg")}`
          );

          result.className = "result show";
          result.textContent = `✅ 图片压缩成功！原始: ${(
            originalSize / 1024
          ).toFixed(1)}KB → 压缩后: ${(newSize / 1024).toFixed(
            1
          )}KB (减少 ${reduction}%)`;
        } catch (e) {
          result.className = "result error show";
          result.textContent = "❌ 错误: " + e;
        }
      };

      window.rotateImage = async function () {
        const file = document.getElementById("rotateImageFile").files[0];
        const degrees = parseInt(
          document.getElementById("rotateDegrees").value
        );
        const result = document.getElementById("rotateResult");

        if (!file) {
          result.className = "result error show";
          result.textContent = "❌ 请选择一张图片";
          return;
        }

        try {
          const buffer = await file.arrayBuffer();
          const rotated = wasm.rotate_image(new Uint8Array(buffer), degrees);
          const blob = new Blob([rotated], { type: file.type });
          downloadFile(blob, `rotated_${degrees}_${file.name}`);

          result.className = "result show";
          result.textContent = `✅ 图片已旋转 ${degrees}° 并下载！`;
        } catch (e) {
          result.className = "result error show";
          result.textContent = "❌ 错误: " + e;
        }
      };

      window.getImageInfo = async function () {
        const file = document.getElementById("infoImageFile").files[0];
        const result = document.getElementById("infoResult");

        if (!file) {
          result.className = "result error show";
          result.textContent = "❌ 请选择一张图片";
          return;
        }

        try {
          const buffer = await file.arrayBuffer();
          const info = JSON.parse(wasm.get_image_info(new Uint8Array(buffer)));

          result.className = "result show";
          result.innerHTML = `
                    <strong>图片信息：</strong><br>
                    📐 尺寸: ${info.width} × ${info.height} px<br>
                    🎨 格式: ${info.format}<br>
                    🖼️ 颜色类型: ${info.color_type}<br>
                    📦 文件大小: ${(file.size / 1024).toFixed(2)} KB
                `;
        } catch (e) {
          result.className = "result error show";
          result.textContent = "❌ 错误: " + e;
        }
      };
    </script>
  </body>
</html>
